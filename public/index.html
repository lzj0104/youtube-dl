<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTubeé¢‘é“æ‰¹é‡ä¸‹è½½å™¨</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .step {
      margin-bottom: 30px;
      padding: 25px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: #fafafa;
      transition: all 0.3s ease;
    }

    .step:hover {
      border-color: #667eea;
      background: white;
    }

    .step h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #444;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      resize: vertical;
      font-size: 14px;
      font-family: monospace;
      transition: border-color 0.3s;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      margin-top: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .controls input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .controls select {
      padding: 8px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .controls select:focus {
      outline: none;
      border-color: #667eea;
    }

    #videoList {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
    }

    .video-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .video-item:hover {
      background: #f5f5f5;
    }

    .video-item:last-child {
      border-bottom: none;
    }

    .video-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 15px;
      cursor: pointer;
    }

    .video-item img {
      width: 160px;
      height: 90px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .video-info {
      flex: 1;
    }

    .video-info h3 {
      font-size: 15px;
      margin-bottom: 8px;
      color: #333;
      line-height: 1.4;
    }

    .video-info span {
      font-size: 13px;
      color: #999;
    }

    .video-info .video-meta {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .video-info .video-date {
      color: #666;
      font-size: 13px;
    }

    .progress-item {
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
    }

    .progress-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      color: #333;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 8px;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: #666;
    }

    .status-icon {
      font-size: 20px;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* åŠ è½½ä¸­æ–‡æœ¬åŠ¨ç”» */
    .loading-text {
      color: #667eea;
      font-style: italic;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* è¯¦æƒ…åŠ è½½é€šçŸ¥æ ·å¼ */
    #details-loading-notice {
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ YouTubeé¢‘é“æ‰¹é‡ä¸‹è½½å™¨</h1>
    <p class="subtitle">è½»æ¾æ‰¹é‡ä¸‹è½½YouTubeé¢‘é“è§†é¢‘ï¼Œæ”¯æŒå¤šé¢‘é“ã€å¤šç”»è´¨é€‰æ‹©</p>

    <!-- æ­¥éª¤1: è¾“å…¥é¢‘é“URL -->
    <section class="step">
      <h2><span class="step-number">1</span> è¾“å…¥é¢‘é“URL</h2>
      <textarea id="channelUrls" placeholder="è¯·è¾“å…¥YouTubeé¢‘é“URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰

ç¤ºä¾‹ï¼š
https://www.youtube.com/@channelname
https://www.youtube.com/c/channelname
https://www.youtube.com/channel/UCxxxxxxxxx"></textarea>
      <button id="fetchBtn" onclick="fetchVideos()">
        <span id="fetchBtnText">ğŸ” è·å–è§†é¢‘åˆ—è¡¨</span>
      </button>
    </section>

    <!-- æ­¥éª¤2: é€‰æ‹©è§†é¢‘ -->
    <section class="step" id="videoSection" style="display:none;">
      <h2><span class="step-number">2</span> é€‰æ‹©è¦ä¸‹è½½çš„è§†é¢‘</h2>
      <div class="controls">
        <label>
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
          <strong>å…¨é€‰</strong> (<span id="videoCount">0</span> ä¸ªè§†é¢‘)
        </label>
        <select id="quality">
          <option value="1080p">ğŸ¥ 1080p é«˜æ¸…</option>
          <option value="720p" selected>ğŸ¥ 720p æ ‡æ¸…ï¼ˆæ¨èï¼‰</option>
          <option value="480p">ğŸ¥ 480p æ™®æ¸…</option>
        </select>
        <button id="downloadBtn" onclick="startDownload()">â¬‡ï¸ å¼€å§‹ä¸‹è½½</button>
      </div>
      <div id="videoList"></div>
    </section>

    <!-- æ­¥éª¤3: ä¸‹è½½è¿›åº¦ -->
    <section class="step" id="progressSection" style="display:none;">
      <h2><span class="step-number">3</span> ä¸‹è½½è¿›åº¦</h2>
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalCount">0</div>
          <div class="stat-label">æ€»æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="completedCount">0</div>
          <div class="stat-label">å·²å®Œæˆ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="failedCount">0</div>
          <div class="stat-label">å¤±è´¥</div>
        </div>
      </div>
      <div id="downloadProgress"></div>
    </section>
  </div>

  <script>
    // Socket.ioè¿æ¥
    const socket = io();

    // å…¨å±€å˜é‡
    let allVideos = [];

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é•¿
    // ==========================================
    function formatDuration(seconds) {
      if (!seconds) return 'æœªçŸ¥æ—¶é•¿';
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;

      if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      return `${minutes}:${String(secs).padStart(2, '0')}`;
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
    // ==========================================
    function formatDate(dateString) {
      if (!dateString) return 'æœªçŸ¥æ—¥æœŸ';

      // è§£æYYYYMMDDæ ¼å¼
      const year = dateString.substring(0, 4);
      const month = dateString.substring(4, 6);
      const day = dateString.substring(6, 8);

      // è¿”å›å‹å¥½æ ¼å¼
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šè·å–è§†é¢‘åˆ—è¡¨
    // ==========================================
    async function fetchVideos() {
      const urls = document.getElementById('channelUrls').value
        .split('\n')
        .filter(url => url.trim());

      if (urls.length === 0) {
        alert('âš ï¸ è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªé¢‘é“URL');
        return;
      }

      const fetchBtn = document.getElementById('fetchBtn');
      const fetchBtnText = document.getElementById('fetchBtnText');

      fetchBtn.disabled = true;
      fetchBtnText.innerHTML = '<span class="loading"></span> å¿«é€Ÿè·å–åŸºæœ¬ä¿¡æ¯ä¸­ï¼ˆ15-30ç§’ï¼‰...';

      try {
        const response = await fetch('/api/channels/fetch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelUrls: urls })
        });

        const result = await response.json();

        if (result.success && result.channels.length > 0) {
          displayVideos(result.channels);
          document.getElementById('videoSection').style.display = 'block';
          showDetailsLoadingNotice(result.totalVideos);
          alert(`âœ… å·²åŠ è½½ ${result.totalVideos} ä¸ªè§†é¢‘ï¼\n\næ—¥æœŸå’Œæ—¶é•¿ä¿¡æ¯æ­£åœ¨åå°åŠ è½½ï¼Œè¯·ç¨å€™...`);
        } else {
          alert('âŒ æœªèƒ½è·å–åˆ°ä»»ä½•è§†é¢‘ï¼Œè¯·æ£€æŸ¥é¢‘é“URLæ˜¯å¦æ­£ç¡®');
        }
      } catch (error) {
        console.error('è·å–è§†é¢‘åˆ—è¡¨å¤±è´¥:', error);
        alert('âŒ è·å–è§†é¢‘åˆ—è¡¨å¤±è´¥: ' + error.message);
      } finally {
        fetchBtn.disabled = false;
        fetchBtnText.innerHTML = 'ğŸ” è·å–è§†é¢‘åˆ—è¡¨';
      }
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ˜¾ç¤ºè§†é¢‘åˆ—è¡¨
    // ==========================================
    function displayVideos(channels) {
      const videoList = document.getElementById('videoList');
      videoList.innerHTML = '';

      allVideos = [];

      // åˆå¹¶æ‰€æœ‰é¢‘é“çš„è§†é¢‘
      channels.forEach(channel => {
        if (channel.videos && channel.videos.length > 0) {
          allVideos = allVideos.concat(channel.videos);
        }
      });

      document.getElementById('videoCount').textContent = allVideos.length;

      if (allVideos.length === 0) {
        videoList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>æœªæ‰¾åˆ°ä»»ä½•è§†é¢‘</p>
          </div>
        `;
        return;
      }

      // æ¸²æŸ“æ¯ä¸ªè§†é¢‘
      allVideos.forEach(video => {
        const div = document.createElement('div');
        div.className = 'video-item';
        div.id = `video-${video.id}`;

        // åˆ¤æ–­æ˜¯å¦æœ‰è¯¦ç»†ä¿¡æ¯
        const durationDisplay = video.duration !== null
          ? formatDuration(video.duration)
          : '<span class="loading-text">åŠ è½½ä¸­...</span>';

        const dateDisplay = video.upload_date !== null
          ? formatDate(video.upload_date)
          : '<span class="loading-text">åŠ è½½ä¸­...</span>';

        div.innerHTML = `
          <input type="checkbox" class="video-checkbox" data-video='${JSON.stringify(video)}'>
          <img src="${video.thumbnail}" alt="${video.title}" onerror="this.src='https://via.placeholder.com/160x90?text=æ— ç¼©ç•¥å›¾'">
          <div class="video-info">
            <h3>${video.title}</h3>
            <div class="video-meta">
              <span id="duration-${video.id}">â±ï¸ ${durationDisplay}</span>
              <span class="video-date" id="date-${video.id}">ğŸ“… ${dateDisplay}</span>
            </div>
          </div>
        `;
        videoList.appendChild(div);
      });
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ˜¾ç¤ºè¯¦æƒ…åŠ è½½é€šçŸ¥
    // ==========================================
    function showDetailsLoadingNotice(totalVideos) {
      // åœ¨è§†é¢‘åˆ—è¡¨ä¸Šæ–¹æ˜¾ç¤ºåŠ è½½è¿›åº¦æ¡
      const videoSection = document.getElementById('videoSection');

      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é€šçŸ¥
      let noticeDiv = document.getElementById('details-loading-notice');
      if (!noticeDiv) {
        noticeDiv = document.createElement('div');
        noticeDiv.id = 'details-loading-notice';
        noticeDiv.style.cssText = `
          padding: 15px;
          margin-bottom: 15px;
          background: #fff3cd;
          border: 1px solid #ffc107;
          border-radius: 6px;
          display: flex;
          align-items: center;
          justify-content: space-between;
        `;

        noticeDiv.innerHTML = `
          <div>
            <strong>ğŸ“¡ æ­£åœ¨åå°åŠ è½½è¯¦ç»†ä¿¡æ¯</strong>
            <div style="margin-top: 5px; font-size: 13px; color: #666;">
              è¿›åº¦: <span id="details-progress-text">0/${totalVideos}</span>
            </div>
          </div>
          <button onclick="cancelDetailsLoading()" style="padding: 6px 12px; font-size: 13px;">å–æ¶ˆ</button>
        `;

        videoSection.insertBefore(noticeDiv, document.getElementById('videoList'));
      }
    }

    // ç§»é™¤åŠ è½½é€šçŸ¥
    function removeDetailsLoadingNotice() {
      const noticeDiv = document.getElementById('details-loading-notice');
      if (noticeDiv) {
        noticeDiv.remove();
      }
    }

    // å–æ¶ˆè¯¦æƒ…åŠ è½½
    function cancelDetailsLoading() {
      if (currentTaskId) {
        socket.emit('video:details:cancel', { taskId: currentTaskId });
        removeDetailsLoadingNotice();
        alert('âš ï¸ å·²å–æ¶ˆè¯¦ç»†ä¿¡æ¯åŠ è½½');
      }
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šå…¨é€‰/å–æ¶ˆå…¨é€‰
    // ==========================================
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.video-checkbox');

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šå¼€å§‹ä¸‹è½½
    // ==========================================
    async function startDownload() {
      const checkboxes = document.querySelectorAll('.video-checkbox:checked');
      const videos = Array.from(checkboxes).map(cb => JSON.parse(cb.dataset.video));

      if (videos.length === 0) {
        alert('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§†é¢‘');
        return;
      }

      const quality = document.getElementById('quality').value;

      try {
        const response = await fetch('/api/downloads/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videos, quality })
        });

        const result = await response.json();

        if (result.success) {
          document.getElementById('progressSection').style.display = 'block';
          document.getElementById('totalCount').textContent = videos.length;
          document.getElementById('completedCount').textContent = '0';
          document.getElementById('failedCount').textContent = '0';

          // æ»šåŠ¨åˆ°è¿›åº¦åŒºåŸŸ
          document.getElementById('progressSection').scrollIntoView({ behavior: 'smooth' });

          alert(`âœ… å·²å¼€å§‹ä¸‹è½½ ${result.count} ä¸ªè§†é¢‘ï¼`);
        }
      } catch (error) {
        console.error('å¯åŠ¨ä¸‹è½½å¤±è´¥:', error);
        alert('âŒ å¯åŠ¨ä¸‹è½½å¤±è´¥: ' + error.message);
      }
    }

    // ==========================================
    // Socket.ioäº‹ä»¶ï¼šä¸‹è½½è¿›åº¦æ›´æ–°
    // ==========================================
    socket.on('download:progress', (data) => {
      updateProgressUI(data);
    });

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ›´æ–°è¿›åº¦UI
    // ==========================================
    function updateProgressUI(data) {
      let progressDiv = document.getElementById(`progress-${data.id}`);

      if (!progressDiv) {
        progressDiv = document.createElement('div');
        progressDiv.id = `progress-${data.id}`;
        progressDiv.className = 'progress-item';
        document.getElementById('downloadProgress').appendChild(progressDiv);
      }

      const statusIcon = data.status === 'completed' ? 'âœ…' :
                        data.status === 'failed' ? 'âŒ' : 'â¬‡ï¸';

      const progress = Math.round(data.progress || 0);

      progressDiv.innerHTML = `
        <div class="progress-title">
          <span class="status-icon">${statusIcon}</span>
          <span>${data.title}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progress}%">
            ${progress > 10 ? progress + '%' : ''}
          </div>
        </div>
        <div class="progress-info">
          <span>${progress}%</span>
          <span>${data.speed || ''}</span>
        </div>
      `;

      // æ›´æ–°ç»Ÿè®¡
      updateStats();
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ›´æ–°ç»Ÿè®¡æ•°æ®
    // ==========================================
    function updateStats() {
      const progressItems = document.querySelectorAll('.progress-item');
      let completed = 0;
      let failed = 0;

      progressItems.forEach(item => {
        const icon = item.querySelector('.status-icon').textContent;
        if (icon === 'âœ…') completed++;
        if (icon === 'âŒ') failed++;
      });

      document.getElementById('completedCount').textContent = completed;
      document.getElementById('failedCount').textContent = failed;
    }

    // ==========================================
    // Socket.ioè¿æ¥äº‹ä»¶
    // ==========================================
    socket.on('connect', () => {
      console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
    });

    socket.on('disconnect', () => {
      console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
    });

    // ==========================================
    // Socket.ioäº‹ä»¶ï¼šè§†é¢‘è¯¦æƒ…æ›´æ–°
    // ==========================================
    let currentTaskId = null;
    let detailsProgress = { current: 0, total: 0, completed: 0, failed: 0 };

    // è¯¦æƒ…è·å–å¼€å§‹
    socket.on('video:details:start', (data) => {
      console.log('å¼€å§‹è·å–è§†é¢‘è¯¦æƒ…:', data);
      currentTaskId = data.taskId;
      detailsProgress = {
        current: 0,
        total: data.total,
        completed: 0,
        failed: 0
      };
    });

    // å•ä¸ªè§†é¢‘è¯¦æƒ…æ›´æ–°
    socket.on('video:details:update', (data) => {
      const { videoId, details, progress, error } = data;

      // æ›´æ–°è¿›åº¦
      if (progress) {
        detailsProgress = progress;
        updateDetailsProgress(progress);
      }

      // æ›´æ–°UI
      if (!error && details) {
        updateVideoDetails(videoId, details);
      } else if (error) {
        markVideoDetailsError(videoId);
      }
    });

    // è¯¦æƒ…è·å–å®Œæˆ
    socket.on('video:details:complete', (data) => {
      console.log('è§†é¢‘è¯¦æƒ…è·å–å®Œæˆ:', data);
      removeDetailsLoadingNotice();
      currentTaskId = null;

      alert(`âœ… è¯¦ç»†ä¿¡æ¯åŠ è½½å®Œæˆï¼\n\næˆåŠŸ: ${data.completed}ä¸ª\nå¤±è´¥: ${data.failed}ä¸ª`);
    });

    // ä»»åŠ¡å–æ¶ˆç¡®è®¤
    socket.on('video:details:cancelled', (data) => {
      console.log('ä»»åŠ¡å·²å–æ¶ˆ:', data);
      if (data.success) {
        removeDetailsLoadingNotice();
        currentTaskId = null;
      }
    });

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ›´æ–°è¯¦æƒ…åŠ è½½è¿›åº¦
    // ==========================================
    function updateDetailsProgress(progress) {
      const progressText = document.getElementById('details-progress-text');
      if (progressText) {
        progressText.textContent = `${progress.current}/${progress.total} (æˆåŠŸ: ${progress.completed}, å¤±è´¥: ${progress.failed})`;
      }
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ›´æ–°å•ä¸ªè§†é¢‘çš„è¯¦ç»†ä¿¡æ¯
    // ==========================================
    function updateVideoDetails(videoId, details) {
      // æ›´æ–°æ—¶é•¿
      const durationElem = document.getElementById(`duration-${videoId}`);
      if (durationElem) {
        durationElem.innerHTML = `â±ï¸ ${formatDuration(details.duration)}`;
      }

      // æ›´æ–°æ—¥æœŸ
      const dateElem = document.getElementById(`date-${videoId}`);
      if (dateElem) {
        dateElem.innerHTML = `ğŸ“… ${formatDate(details.upload_date)}`;
      }

      // æ›´æ–° allVideos æ•°ç»„ä¸­çš„æ•°æ®
      const videoIndex = allVideos.findIndex(v => v.id === videoId);
      if (videoIndex !== -1) {
        allVideos[videoIndex].duration = details.duration;
        allVideos[videoIndex].upload_date = details.upload_date;
        allVideos[videoIndex].detailsLoading = false;

        // æ›´æ–° checkbox çš„ data-video å±æ€§
        const checkbox = document.querySelector(`input[data-video*='"id":"${videoId}"']`);
        if (checkbox) {
          checkbox.setAttribute('data-video', JSON.stringify(allVideos[videoIndex]));
        }
      }
    }

    // ==========================================
    // åŠŸèƒ½å‡½æ•°ï¼šæ ‡è®°è§†é¢‘è¯¦æƒ…è·å–å¤±è´¥
    // ==========================================
    function markVideoDetailsError(videoId) {
      const durationElem = document.getElementById(`duration-${videoId}`);
      if (durationElem) {
        durationElem.innerHTML = `â±ï¸ <span style="color: #999;">è·å–å¤±è´¥</span>`;
      }

      const dateElem = document.getElementById(`date-${videoId}`);
      if (dateElem) {
        dateElem.innerHTML = `ğŸ“… <span style="color: #999;">è·å–å¤±è´¥</span>`;
      }
    }

    // ==========================================
    // é¡µé¢å¸è½½æ—¶å–æ¶ˆä»»åŠ¡
    // ==========================================
    window.addEventListener('beforeunload', () => {
      if (currentTaskId) {
        // ä½¿ç”¨ sendBeacon å‘é€å–æ¶ˆè¯·æ±‚
        navigator.sendBeacon('/api/channels/cancel-details', JSON.stringify({ taskId: currentTaskId }));
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    console.log('%cğŸ¬ YouTubeé¢‘é“æ‰¹é‡ä¸‹è½½å™¨', 'color: #667eea; font-size: 24px; font-weight: bold;');
    console.log('%cå·²å°±ç»ªï¼å¼€å§‹è¾“å…¥é¢‘é“URLå§~', 'color: #764ba2; font-size: 14px;');
  </script>
</body>
</html>
