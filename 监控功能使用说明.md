# YouTube频道自动监控功能使用说明

## 🎯 功能概述

自动监控功能可以定期检查指定YouTube频道的最新视频，自动下载新发布的内容，无需手动操作。

### 核心特性

- ✅ **自动检查**: 每5分钟检查一次已启用的频道
- ✅ **智能去重**: 永久记录videoId，重启不重复下载
- ✅ **并发下载**: 最多3个视频同时下载
- ✅ **失败重试**: 自动重试1次
- ✅ **自动清理**: 5天后自动删除文件（保留去重记录）
- ✅ **默认画质**: 720p
- ✅ **实时推送**: Socket.io实时更新状态

---

## 🚀 快速开始

### 方法1：修改配置文件启用（推荐）

1. **编辑配置文件**
   ```bash
   vim src/config.js
   ```

2. **修改 `enabled` 为 `true`**
   ```javascript
   module.exports = {
     monitoring: {
       enabled: true,  // ← 改为 true
       checkInterval: 5 * 60 * 1000,     // 5分钟
       latestVideosCount: 3,             // 检查最新3个视频
       maxConcurrentDownloads: 3,        // 最多3并发
       defaultQuality: '720p',
       fileRetentionDays: 5
     }
   };
   ```

3. **重启服务**
   ```bash
   npm start
   # 或使用 PM2
   npm run pm2:restart
   ```

### 方法2：使用PM2（生产环境）

```bash
# 安装PM2（如果还没有）
npm install -g pm2

# 启动服务
npm run pm2:start

# 查看日志
npm run pm2:logs

# 开机自启
pm2 startup
pm2 save
```

---

## 📺 使用监控功能

### 1. 访问Web界面

打开浏览器访问: `http://localhost:3000`

### 2. 添加监控频道

在 **"⚙️ 自动监控管理"** 区块：

1. 输入YouTube频道URL，例如：
   ```
   https://www.youtube.com/@channelname
   https://www.youtube.com/c/channelname
   https://www.youtube.com/channel/UCxxxxxxxxx
   ```

2. 输入频道名称（可选，方便识别）

3. 点击 **"➕ 添加"** 按钮

### 3. 启用/禁用频道

- 使用 **开关按钮** 可以临时启用或禁用某个频道的监控
- 禁用后该频道不会被定期检查，但不会删除已下载的文件

### 4. 手动检查

点击 **"🔄 立即检查"** 按钮可以手动触发检查，无需等待定时任务。

### 5. 查看状态

界面会实时显示：
- **监控状态**: 运行中 / 已停止 / 已禁用
- **下载队列**: 等待中和正在下载的视频数量
- **频道列表**: 所有已添加的频道及其最后检查时间

---

## ⚙️ 配置说明

### 监控配置 (src/config.js)

```javascript
monitoring: {
  enabled: false,                    // 全局监控开关
  checkInterval: 5 * 60 * 1000,     // 检查间隔（毫秒）
  latestVideosCount: 3,             // 每频道检查最新N个视频
  maxConcurrentDownloads: 3,        // 最大并发下载数
  defaultQuality: '720p',           // 默认下载画质
  fileRetentionDays: 5              // 文件保留天数
}
```

### 画质选项

- `1080p` - 1080p高清
- `720p` - 720p标清（推荐，默认）
- `480p` - 480p普清

### 检查间隔建议

- **5分钟** - 推荐，适合大多数场景
- **10分钟** - 如果频道更新不频繁
- **不建议低于5分钟** - 避免对YouTube服务器造成压力

---

## 🔧 工作流程

```
[定时触发: 每5分钟]
    ↓
获取所有 enabled=true 的频道
    ↓
遍历每个频道:
    ├─ 快速获取最新3个视频的基本信息
    ├─ 对每个视频:
    │   ├─ 检查 videoId 是否已存在
    │   ├─ 如果不存在:
    │   │   ├─ 添加到数据库（永久去重）
    │   │   └─ 加入下载队列
    │   └─ 如果存在: 跳过
    ├─ 更新频道最后检查时间
    └─ Socket.io 实时推送新视频通知
```

---

## 📊 数据存储

### 存储位置

所有数据存储在 `./data/storage.json` 文件中。

### 数据结构

```json
{
  "channels": [
    {
      "id": "ch_1234567890",
      "url": "https://youtube.com/@example",
      "name": "示例频道",
      "enabled": true,
      "lastCheckAt": "2026-01-16T10:00:00Z",
      "createdAt": "2026-01-15T08:00:00Z"
    }
  ],
  "videos": {
    "videoId1": {
      "channelId": "ch_1234567890",
      "title": "视频标题",
      "url": "https://youtube.com/watch?v=videoId1",
      "discoveredAt": "2026-01-16T10:00:00Z"
    }
  },
  "downloads": [...]
}
```

### 去重机制

- **videos对象**: 使用 `videoId` 作为key，天然去重
- **永久记录**: 即使删除文件，videoId记录仍保留
- **重启安全**: 重启服务后不会重复下载旧视频

---

## 🧹 自动清理

### 清理策略

- **触发时间**: 每天凌晨3点自动执行
- **清理条件**: 下载完成时间超过5天
- **清理内容**:
  - ✅ 删除视频文件 (.mp4)
  - ✅ 删除缩略图 (.jpg)
  - ❌ 保留去重记录（videos表）

### 手动触发清理

目前不支持手动触发，如需手动清理可以：

```bash
# 删除downloads目录下的旧文件
find downloads -type f -mtime +5 -delete
```

---

## 🔍 故障排查

### 监控状态显示"已禁用"

**原因**: `src/config.js` 中 `monitoring.enabled = false`

**解决**: 修改配置文件为 `true` 并重启服务

### 频道检查失败

**可能原因**:
1. YouTube频道URL格式不正确
2. yt-dlp未安装或版本过旧
3. 网络连接问题

**解决**:
```bash
# 更新 yt-dlp
pip install --upgrade yt-dlp

# 测试频道URL
yt-dlp --flat-playlist --dump-json "频道URL"
```

### 下载失败

**可能原因**:
1. 视频被删除或设为私密
2. YouTube限流
3. 磁盘空间不足

**查看日志**:
```bash
# 查看PM2日志
npm run pm2:logs

# 查看错误日志
tail -f logs/error.log
```

### 数据文件损坏

系统会自动备份损坏的文件到 `./data/storage.json.backup.{timestamp}`

---

## 📝 API端点

如果需要通过API管理监控（例如自动化脚本）:

```bash
# 获取监控状态
curl http://localhost:3000/api/monitor/status

# 添加频道
curl -X POST http://localhost:3000/api/monitor/channels/add \
  -H "Content-Type: application/json" \
  -d '{"url":"https://youtube.com/@example","name":"示例频道"}'

# 启用/禁用频道
curl -X POST http://localhost:3000/api/monitor/channels/toggle \
  -H "Content-Type: application/json" \
  -d '{"id":"ch_1234567890","enabled":true}'

# 删除频道
curl -X DELETE http://localhost:3000/api/monitor/channels/ch_1234567890

# 手动立即检查
curl -X POST http://localhost:3000/api/monitor/check-now
```

---

## ⚡ 性能优化建议

1. **并发控制**: 不建议将 `maxConcurrentDownloads` 设置超过5
2. **检查间隔**: 建议不少于5分钟，避免触发YouTube限流
3. **磁盘空间**: 定期检查 `downloads` 目录大小
4. **日志管理**: 使用PM2的日志轮换功能

---

## 🛡️ 安全建议

1. **不要暴露端口**: 如果在公网服务器上运行，不要开放3000端口
2. **定期备份**: 定期备份 `./data/storage.json` 文件
3. **监控日志**: 定期检查错误日志，发现异常及时处理

---

## 📞 常见问题

**Q: 可以同时监控多少个频道？**
A: 理论上无限制，但建议不超过20个以保证性能。

**Q: 监控会消耗多少资源？**
A: 空闲时几乎不消耗资源，检查时会短暂占用CPU和网络。

**Q: 可以修改下载画质吗？**
A: 当前只能通过修改 `src/config.js` 中的 `defaultQuality` 配置。

**Q: 重启后会重复下载吗？**
A: 不会，系统会永久记录已下载视频的videoId。

**Q: 可以下载字幕吗？**
A: 当前版本暂不支持，计划在未来版本添加。

---

## 🔄 更新日志

### v2.0.0 (2026-01-16)
- ✅ 新增自动监控功能
- ✅ 新增下载队列管理
- ✅ 新增自动文件清理
- ✅ 新增频道管理界面
- ✅ 支持PM2进程管理

---

## 📄 许可证

ISC

---

**享受自动化的便利吧！🎉**
